<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Asset Price List</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
</head>

<body>


    <div class="titleContainer">
        <span class="title">Asset Price List</span>
        <div class="input-group">
            <input type="text" id="tokenInput" placeholder="Enter token here">
            <button class="icon-btn" onclick="saveToken()"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="success-message" id="successMessage" style="display: none; opacity: 0;">Token added successfully
        </div>
        <div class="fetch-container">
            <button class="get-btn" onclick="fetchPriceList()">Fetch Prices</button>
        </div>
        <div class="copy-container">
            <button class="get-btn" onclick="fetchPriceList()">Copy to clipboard</button>
        </div>
    </div>

    <!-- Email template section -->
    <div class="asset-container">
        <div id="bullion" class="asset-box">
            <div id="bullionCopy">
                <table style="border:1px solid black; width:100%; border-spacing: 0px !important;" cellspacing="0"
                    cellpadding="0">
                    <tbody>
                        <tr>
                            <td style="padding-bottom: 10px; border-bottom: 1px solid black;">
                                <span>Gold:Siver Ratio - 88.87</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-bottom: 10px; border-bottom: 1px solid black;">
                                <span>AUD/USD - 0.6565</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-bottom: 10px; border-bottom: 1px solid black;">
                                <span>Gold - US$2,418 (Up US$21 / 0.98%) AU$3,273 (Up AU$4 / 0.12%)</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-bottom: 10px; border-bottom: 1px solid black;">
                                <span>Silver - US$2,418 (Up US$21 / 0.98%) AU$3,273 (Up AU$4 / 0.12%)</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="digital" class="asset-box">
            <div id="digitalCopy">
                <table style="border:1px solid black; width:100%; border-spacing: 0px !important;" cellspacing="0"
                    cellpadding="0">
                    <tbody>
                        <tr>
                            <td style="padding-bottom: 10px; border-bottom: 1px solid black;">
                                <span>Gold:Siver Ratio - 88.87</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-bottom: 10px; border-bottom: 1px solid black;">
                                <span>AUD/USD - 0.6565</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-bottom: 10px; border-bottom: 1px solid black;">
                                <span>Gold - US$2,418 (Up US$21 / 0.98%) AU$3,273 (Up AU$4 / 0.12%)</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-bottom: 10px; border-bottom: 1px solid black;">
                                <span>Silver - US$2,418 (Up US$21 / 0.98%) AU$3,273 (Up AU$4 / 0.12%)</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="price-list">
    </div>


    <div class="helpContainer">
        <div id="help" class="tokenHelp">
            You do not have a Token stored in this session. Please follow these steps:
            <ol>
                <li>
                    Go to <a href="https://dev-api.ainsliebullion.com.au"
                        target="_blank">https://dev-api.ainsliebullion.com.au</a> and log in
                </li>
                <li>
                    After logging in, click on your email address at the top right of the screen
                </li>
                <li>
                    Click on "Generate New Token", then click on "Copy"
                </li>
                <li>
                    Paste the token at the top of this page where it says "Enter token here", and click the
                    submission
                    arrow
                </li>
                <li>
                    You should now be able to use the "Fetch Prices" button
                </li>
            </ol>


        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const token = getCookie('apiToken');
            const inputGroup = document.querySelector('.input-group');
            const fetchContainer = document.querySelector('.fetch-container');
            const copyContainer = document.querySelector('.copy-container');

            if (!token) {
                inputGroup.style.display = 'flex';
                fetchContainer.style.display = 'none';
                copyContainer.style.display = 'none';
            } else {
                inputGroup.style.display = 'none';
                fetchContainer.style.display = 'flex';
                copyContainer.style.display = 'flex';
            }
        });


        function fadeIn(element, callback = () => { }) {
            element.style.opacity = 0;
            element.style.display = 'flex';
            setTimeout(() => {
                element.style.transition = 'opacity 1s';
                element.style.opacity = 1;
                setTimeout(callback, 1000);
            }, 10);
        }

        function fadeOut(element, callback = () => { }) {
            element.style.transition = 'opacity 1s';
            element.style.opacity = 0;
            setTimeout(() => {
                element.style.display = 'none';
                callback();
            }, 1000);
        }

        function saveToken() {
            const tokenInput = document.getElementById('tokenInput');
            const token = tokenInput.value;
            const fetchContainer = document.querySelector('.fetch-container');
            const copyContainer = document.querySelector('.copy-container');
            const helpContainer = document.querySelector('.helpContainer');
            const emailContainer = document.querySelector('.emailContainer');
            const inputGroup = document.querySelector('.input-group');
            const successMessage = document.getElementById('successMessage');

            if (!token) return;
            if (token.length < 2) {
                tokenInput.value = "";
                tokenInput.placeholder = "Token too short, please enter a valid token";
                return;
            }

            document.cookie = `apiToken=${token};path=/`;

            fadeOut(inputGroup, () => {
                tokenInput.value = '';
                successMessage.style.display = 'block';
                fadeIn(successMessage, () => {
                    setTimeout(() => {
                        fadeOut(successMessage, () => {
                            fetchContainer.style.opacity = 0;
                            copyContainer.style.opacity = 0;

                            fadeIn(fetchContainer);
                            fadeIn(copyContainer);
                            fadeIn(emailContainer);
                        });
                        fadeOut(helpContainer);
                    }, 2000);
                });
            });

            fetchContainer.style.display = 'none';
            copyContainer.style.display = 'none';
        }


        function fetchPriceList() {
            const token = getCookie('apiToken');
            fetch('https://dev-api.ainsliebullion.com.au/assets/pricelist', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    displayPriceList(data);
                    priceSheetCalcs(data);
                    console.log(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('price-list').innerHTML = '<p>Error loading price list.</p>';
                });
        }

        function priceSheetCalcs(data) {
            // Initialize variables to store the spot prices of Gold and Silver
            let goldSpotPrice = 0;
            let silverSpotPrice = 0;

            // Ensure data is an array
            if (data && Array.isArray(data)) {
                data.forEach(item => {
                    // Check for Gold and update its spot price
                    if (item.assetName === "Gold") {
                        goldSpotPrice = item.spot;
                    }
                    // Check for Silver and update its spot price
                    else if (item.assetName === "Silver") {
                        silverSpotPrice = item.spot;
                    }
                });
            }

            // Calculate the Gold to Silver Ratio if both prices are available
            if (goldSpotPrice > 0 && silverSpotPrice > 0) {
                let GSR = goldSpotPrice / silverSpotPrice;
                console.log(`Gold to Silver Ratio: ${GSR}`);
            } else {
                console.log("Gold or Silver data missing");
            }
        }

        function displayPriceList(data) {
            const priceListDiv = document.getElementById('price-list');
            let html = '<ul>';

            if (data && Array.isArray(data)) {
                data.forEach(item => {
                    html += `<li>${item.assetName}: $${item.spot}</li>`;
                });
            } else {
                html += '<li>No data found</li>';
            }

            html += '</ul>';
            priceListDiv.innerHTML = html;
        }


        function getCookie(name) {
            let cookieArr = document.cookie.split(";");
            for (let i = 0; i < cookieArr.length; i++) {
                let cookiePair = cookieArr[i].split("=");
                if (name == cookiePair[0].trim()) {
                    return decodeURIComponent(cookiePair[1]);
                }
            }
            return null;
        }
    </script>

</body>

</html>